package himanshu.shopify_android;


import android.content.Intent;
import android.os.Handler;
import android.support.v7.app.AppCompatActivity;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.view.ViewGroup;
import android.widget.BaseAdapter;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.ProgressBar;
import android.widget.TextView;
import android.widget.Toast;

import com.squareup.picasso.Picasso;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.ArrayList;

public class CollectionsDetailsActivity extends AppCompatActivity implements FetchServiceResultReceiver.Receiver{


    private static final int PRODUCTS_IDS_FETCH = 1;
    private static final int PRODUCTS_INFO_FETCH = 2;
    private ArrayList<Product> productList;

    @Override
    protected void onCreate(Bundle savedInstanceState) {

        super.onCreate(savedInstanceState);

        setTitle(getString(R.string.collectionDetailPage));;
        setContentView(R.layout.activity_collections_details);

        TextView collectionName = findViewById(R.id.collection_name);
        TextView collectionBody = findViewById(R.id.collection_body);
        ImageView collectionImage = findViewById(R.id.collection_image);
        Collection currentCollection = getIntent().getParcelableExtra(getResources().getString(R.string.collection));
        String productsList = String.format(getResources().getString(R.string.product_ids), Long.toString(currentCollection.getID()));
        collectionName.setText(currentCollection.getName());
        collectionBody.setText(currentCollection.getBody());

        Picasso.get().load(currentCollection.getImage()).into(collectionImage);
        startFetchService(productsList, PRODUCTS_IDS_FETCH);
    }

    private void startFetchService(String url,int fetchCallNumber){

        FetchServiceResultReceiver fetchServiceCallback = new FetchServiceResultReceiver(new Handler());
        fetchServiceCallback.setReceiver(this);

        Intent intent = new Intent(CollectionsDetailsActivity.this, FetchService.class);
        intent.putExtra(getResources().getString(R.string.url), url);
        intent.putExtra(getResources().getString(R.string.callNum), fetchCallNumber);
        intent.putExtra(getResources().getString(R.string.callback), fetchServiceCallback);
        startService(intent);
    }

    @Override
    public void onReceiveResult(int resultCode, Bundle resultData) {

        String data = resultData.getString(getResources().getString(R.string.fetchedData));

        if(resultCode == PRODUCTS_IDS_FETCH){
            try {
                JSONObject jsonData = new JSONObject(data);
                JSONArray collects = jsonData.getJSONArray(getResources().getString(R.string.jsonCollects));
                StringBuffer urlBuffer = new StringBuffer();

                for(int i = 0; i < collects.length(); i++){
                    JSONObject jsonCollection = collects.getJSONObject(i);
                    urlBuffer.append(jsonCollection.getLong(getResources().getString(R.string.jsonProductID)));
                    urlBuffer.append(",");
                }

                String URL = String.format(getResources().getString(R.string.product_url),urlBuffer.toString());
                startFetchService(URL,PRODUCTS_INFO_FETCH);

            }catch(JSONException jException){
                Toast.makeText(this, "Couldn't translate JSON\n" + jException.getLocalizedMessage(), Toast.LENGTH_LONG).show();
            }
        }else if (resultCode == PRODUCTS_INFO_FETCH){
            try{
                JSONObject jsonData = new JSONObject(data);
                productList = prepareProductList(jsonData.getJSONArray(getResources().getString(R.string.jsonProducts)));

                ListView productListView = findViewById(R.id.product_list_view);
                productListView.setAdapter(new ProductsListAdapter(productList));

                ProgressBar progressSpinner = findViewById(R.id.progress);
                progressSpinner.setVisibility(View.GONE);

            }catch (JSONException jException){
                Toast.makeText(this, "Couldn't translate JSON\n" + jException.getLocalizedMessage(), Toast.LENGTH_LONG).show();
            }
        }else if (resultCode == 0){
            Toast.makeText(this, "An unexpected error has occurred", Toast.LENGTH_LONG).show();
        }
    }

    private ArrayList<Product> prepareProductList(JSONArray productData){
        ArrayList<Product> products = new ArrayList<>();
        try {
            for (int i = 0; i < productData.length(); i++) {
                JSONObject jsonProduct = productData.getJSONObject(i);
                ArrayList<String> variants = new ArrayList<>();
                JSONArray jsonVariants = jsonProduct.getJSONArray(getResources().getString(R.string.jsonVariants));
                int totalInventory = 0;

                for (int j = 0; j < jsonVariants.length(); j++){
                    JSONObject cVariant = jsonVariants.getJSONObject(j);
                    totalInventory += cVariant.getInt(getResources().getString(R.string.jsonInventoryQuantity));
                    variants.add(cVariant.getString(getResources().getString(R.string.jsonName)));
                }
                products.add(new Product(
                        jsonProduct.getString(getResources().getString(R.string.jsonName)),
                        jsonProduct.getString(getResources().getString(R.string.jsonBody)),
                        jsonProduct.getJSONObject(getResources().getString(R.string.jsonImage)).getString(getResources().getString(R.string.jsonSrc)),
                        jsonProduct.getLong(getResources().getString(R.string.jsonID)),
                        totalInventory,
                        variants));
            }
        }catch(JSONException jException){
            Log.d("Product-Test", jException.getMessage());
        }
        return  products;
    }

    public class ProductsListAdapter extends BaseAdapter {
        ArrayList<Product> products;
        public ProductsListAdapter(ArrayList<Product> products){
            this.products = products;
        }

        @Override
        public int getCount() {
            return products.size();
        }

        @Override
        public Object getItem(int index) {
            return products.get(index);
        }

        @Override
        public long getItemId(int i) {
            return i;
        }

        /**
         * Uses a ViewHolder for smooth scrolling by decreasing the amount of times findViewById() is called
         */
        @Override
        public View getView(int index, View view, ViewGroup viewGroup) {
            ViewHolder viewHolder;

            Product selectedProduct = products.get(index);
            if(view == null){
                view=getLayoutInflater().inflate(R.layout.product_list_element,null);
                viewHolder=new ViewHolder();
                viewHolder.productNameView =view.findViewById(R.id.product_name);
                viewHolder.productBodyView = view.findViewById(R.id.collection_body);
                viewHolder.productInventoryView = view.findViewById(R.id.product_inventory);
                viewHolder.productImageView = view.findViewById(R.id.collection_image);
                view.setTag(viewHolder);
            }else{
                viewHolder=(ViewHolder) view.getTag();
            }
            viewHolder.productNameView.setText(selectedProduct.getName());
            viewHolder.productBodyView.setText(selectedProduct.getBody());
            viewHolder.productInventoryView.setText(String.format(getString(R.string.in_stock_message),String.valueOf(selectedProduct.getTotalInventory())));
            Picasso.get().load(selectedProduct.getImage()).into(viewHolder.productImageView);
            return view;
        }

        class ViewHolder {
            TextView productNameView;
            TextView productBodyView;
            TextView productInventoryView;
            ImageView productImageView;
        }
    }
}
